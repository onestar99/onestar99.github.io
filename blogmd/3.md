# '요리조리' 레시피 사이트의 백엔드를 맡아 진행하며 생겼던 치명적 문제들

사용 기술: 스프링 부트2.8 , 자바8, 파이썬 3.9.4, Mysql 8.1

도구: intellij, notion, git, heidisql, mysql workbench, vsc, kakaotalk, discord


## Front와의 소통 문제
API를 위한 각 json 형식 문제, 
이러한 것 때문에 쓸때 없는 코드들이 늘어나고 재생산하고를 반복했다. 
나중에 이르러서 더 자주 카톡하고, 노션을 통해 정리를 하기 시작하면서 문제가 점점 줄어들었다.

(솔직히 내가 변수 명을 너무 못 지었다 미안하다 프론트 동료야!!)

이때는 몰랐는데 솔직히 지금와서는 Postman에 API 양식을 같이 작성하면서 공유했으면 더 편하게 했을 것 같기도 하다.

## RDB 스키마 수정과 외래키에 따른 RelationShip 강제 문제
사전에 ERD를 만들어 둔 대로 스키마를 구성하고 테이블들을 구성했었다. 처음에는 계획대로 잘 흘러갔으나 나중에 테이블 구성을 잘못 했다는 것을 알고 조금씩 수정하며 바꾸었었다. 바로 여기서 문제가 터졌는데 관계를 맺은 데이터들을 삭제할 때는 역순으로 삭제해야 한다는 점이다.

테이블의 관계에서 부모 테이블에서 자식 테이블로 쭉 내려가다보면 부모 데이터를 지울 때는 관계되어있는 자식 데이터들을 전부 삭제 해야한다는 점이다. (이때는 Cascade를 모르고 진행하여 역순으로 일일히 다 삭제했었다.)

우리 사이트가 가지는 요구사항은 회원 탈퇴를 하더라도 작성한 데이터들은 따로 요청하지 않는 이상 데이터가 유지되도록 하는 것이었다. 테이블간 관계를 맺을 때 유저 테이블과 레시피 테이블을 묶어버렸으니 매우 큰 문제가 발생한 것이다.

개발 당시에는 여러 아이디어를 생각하다가 '삭제를 하기전에 똑같은 데이터들을 생산하자!' 라는 아이디어로 귀결이 되었는데 지금 생각해보면 FK들을 null로 업데이트하면 되는 문제인데 왜 이렇게 어렵게 생각했을까? 아쉽기만 하다.

또 FK 지정과 관련된 이야기인데, 지금 와서도 아직까지 고민인 문제다. FK를 지정 하지 않고 팀과 따로 이야기하여 DB 서버쪽이나 JPA에서 인덱스를 만드는 것이 개발하고 테스트하는데 있어서 빠른 강점을 가지겠지만, 만약에 서비스 도중 혹시라도 갑작스러운 문제로 동시성 관리 문제가 발생하거나 꼼꼼하게 코드를 확인 안해서 트랜잭션 트러블 슈팅이라도 나는 경우에는... 이후 유지보수는 매우 끔직한 사태로 번진다. 데이터의 무결성을 위해서라도 하는편이 좋은 것 같다.

## EC2 서버 자체의 하드웨어 RAM 용량의 문제
EC2 프리티어를 사용하고 있었기에 t2.micro 인스턴스를 사용 중 이었다. RAM 용량이 무려 1GB이다. 이 정도면 요즘 서버에서 필요로 하는 무거운 것들을 돌리기에 무리가 있었다. 

예를 들어 ec2 서버에 ssh 접속을 한 상태로, 프로젝트를 git pull 한 뒤 여기에서 build를 할 경우 문제가 생겼다. 한번에 deploy 가능하도록 파이프라인 쉘을 구성하고 싶었는데 빌드만 하면 서버가 죽어버리는 현상이 발생했다. 

어쩔 수 없이 빌드는 데스크탑이나 노트북으로 빌드를 하고 jar파일을 FTP로 전송해서 서버를 키는 매우 성가신 작업을 일일히 해줬었다. 여기까지는 그래도 급한 문제는 아니어서 그냥 했었다.

진짜 급한 문제는 같은 인스턴스에 AI 기능을 제공하기 위한 간단한 Flask서버를 만들었었는데 이 서버를 키는 동안 AI 모델을 불러오는 RAM이 생각보다 매우 컸다. 나중에 확인해보니 대략 얘 혼자만 1300MB 정도를 잡아먹었다. 이제는 서버를 옮기든 방안을 생각했어야 했다.

**간단하게 Swap 메모리 파티션 만들어서 해결했다.** 김이 좀 샐수 있는데 나도 어이가 없었다. 이걸 왜 생각을 못하고 있었는지 비참하기까지 했다. 작동만 시켜보자는 식으로 2048MB 정도 파티션 만들어서 서버를 켜보니 작동을 했다. 문제는 Flask서버쪽 API가 많이 늦었다. 아무래도 모델 불러와서 사용하려니 이래저래 성능이 좋지 않은 인스턴스는 부담이 컸다.

지금와서 돌이켜보면 Flask 서버는 내 개인 컴퓨터를 사용했으면 좋았을 걸 이라는 생각을 한다. 개발 당시 이걸 생각을 못한 것은 아니었으나 포트 포워딩이랑 방화벽이라는 벽에 가로막혀 진전이 없었다. 지금은 이제 할줄 아니까 하는 소리이기도 하다.

## AWS RDS의 잘못된 사용으로 인한 많은 요금 부과
AWS RDS를 사용하여 개발하던 도중 테스트 데이터를 잘못 변경하여 이전 상태로 돌리는 작업을 진행하였는데, 팀원이 잘못 설정하여 다중-AZ DB 클러스터를 켜버리는 바람에 나중에 요금이 부과되어서야 문제를 파악했다.
대략 50만원 정도 부과되었다...

**클라우드 서비스를 이용한다면 요금 부과 사항은 꼭꼭 자주 확인하자.**

팀원들과 머리 싸매면서 장문의 잘못했다는 영어로 된 편지를 만들어 AWS팀에 전송했다. 초조하게 며칠을 기다린 결과, 이를 가엽게 여긴 너그러운 AWS팀은 요금을 감면해주었다. 정말 감사한 일이었다...

이 사건 이후로 다른 토이 프로젝트 할 때는 RDS 안 쓴다. 무료기간이 끝나가는 것도 있고, 돈이 많이 들어가서 무섭다. 라즈베리파이로 집에서 작은 DB서버 하나 만들고 싶었으나 얘도 돈이 좀 들어가서 예산 문제로 포기, 현재는 방안 서랍에서 놀던 핸드폰 가지고 리눅스로 써먹고 있다.

## application.yml 깃 유출
완벽한 잘못이다. 단순하게 팀원과 private하게 저장소를 공유하려고만 생각하였고 application.yml에 적힌 여러 엔드포인트나 시크릿 키들이 깃에 노출되었다. 현재에 이르러서 코드를 public으로 돌릴 때 문제가 커지기 때문에 깃의 내용들을 수정할 필요가 있어졌다.

이를 해결하기 위해 'git filter-branch'를 사용하여 저장소에 저장되어있는 application.yml 관련 내용들을 싹 날렸다.

**절대로 유출되지 않도록 하자.**